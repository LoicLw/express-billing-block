<% if (invoices.find(invoice => invoice.unpaid)) { %>
	<div class="alert alert-danger" role="alert">
		We couldn't bill your card for the latest period. Please <b>update your card now</b> to keep your subscription active and your account from being deleted.<br>If you need assistance, please contact us.
	</div>
<% } %>

<% if (subscriptions.length) { %>

	<% if (user.stripe.canceled) { %>
		
		<div class="alert alert-warning" role="alert">
			Your subscription will be canceled at the end of the billing period on <b><%= subscriptions[0].currentPeriodEnd %></b>. <a href="/billing/resumesubscription">Click here</a> to resume it before it's too late.
		</div>

	<% } else { %>

		<% for (let sub of subscriptions.filter(sub => sub.plan)) {Â %>

			<p>Your <b><%= sub.name %></b> plan
			
			<% if (sub.plan.usage_type !== 'metered') { %>
			 is set to <b><%= sub.plan.amount %> per <%= sub.plan.interval_count !== 1 ? sub.plan.interval_count : '' %> <%= sub.plan.interval %></b> and
			<% }Â %>

			will <%= sub.status === 'trialing' ? 'start' : 'renew' %> <b><%= sub.currentPeriodEnd %></b>.</p>

			<p><small><%= sub.discountDescription ? 'Applied coupon ' + sub.discountDescription : '' %></small></p>

		<% } %>

	<% } %>

	<% if (userPlan && options.upgradable) { %> 

		<% if (upgradablePlans.find(p => p.isHigher) ) { %>
			<p><button type="button" class="btn btn-sm btn-outline-success" data-toggle="modal" data-target="#upgradeModal">Upgrade your plan ðŸš€</button></p>
		<% } %>

		<% if (upgradablePlans.find(p => p.isLower)) { %>
			<p><small><a href='#' data-toggle="modal" data-target="#upgradeModal">Downgrade your plan</a></small></p>
		<% }Â %>
	
	<% } %>


<% } else if (options.upgradable) { %>

	<button type="button" class="btn btn-outline-success" data-toggle="modal" data-target="#upgradeModal">Upgrade your plan ðŸš€</button>
	<br>

<% } %>

<h5 class="my-3">Payment method</h5>
	
<button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#cardModal">+ Add a new card</button>

<ul class="list-group py-3 mb-1">
	<% for (let method of paymentMethods) {Â %>
		<li class="list-group-item d-flex justify-content-between align-items-center">

			<span>
				<img class='mr-2' src='https://rawcdn.githack.com/FreshVine/Payment-Methods-SVG/c441556f81b9a9950ab03d0d96b27fb1493ce22a/icons/cards/<%= method.card.brand %>.svg' width=30/>
				 <b>Â·Â·Â·Â· Â·Â·Â·Â· Â·Â·Â·Â·</b> <%= method.card.last4 %> 
				 <span class="badge badge-<%= method.card.exp_year > new Date().getFullYear() ? 'success' : ( method.card.exp_year < new Date().getFullYear() ? 'danger' : 'warning') %>">exp <%= method.card.exp_year %></span>
			</span>
			
			<% if (method.isDefault) { %>
				<span class="badge badge-success">in use</span>
			<% }Â else { %>
				<div>
					<a href='/billing/setcarddefault?id=<%= method.id %>' class="btn-primary btn btn-sm small">select</a>
					<a onclick="return confirm('Are you sure you want to delete this card?');" href='/billing/removecard?id=<%= method.id %>' class="text-danger small"><span class="oi oi-trash"></span></a>
				</div>
			<% }Â %>

		</li>
	<% } %>
</ul>

<% if (invoices.length) { %> 
	<h5>Billing history</h5>

	<ul class="list-group py-3">				
		<% for (let invoice of invoices) {Â %>
			<li class="list-group-item d-flex justify-content-between align-items-center">
				<% if (invoice.status === 'draft') { %>
					<div class='m-0'>
						Draft invoice for <b><%= invoice.amount %></b>
						<span class="badge badge-secondary">upcoming</span>
						<br>
						<% for (let line of invoice.lines.data.filter(l => l.amount > 0)) { %>
							<p><small><%= line.description %></small></p>
						<% } %>
						<br>
						<p><small><%= invoice.cleanPeriodStart %> â†’ <%= invoice.cleanPeriodEnd %></small></p>
					</div>
				<%Â } else { %>
					<p class='m-0'>
						Invoice for <b><%= invoice.amount %></b>
						<span class="badge badge-<%= invoice.status === 'paid' ? 'success' : ( invoice.unpaid ? 'danger' : 'warning') %>"><%= invoice.unpaid ? 'payment failed, please update card' : invoice.status %></span>
						<br>
						<small><%= invoice.cleanPeriodStart %> â†’ <%= invoice.cleanPeriodEnd %></small>
					</p>
				<% } %>

				<% if (invoice.invoice_pdf) {Â %>
					<a target='_blank' href='<%= invoice.invoice_pdf %>'>â†“ Download</a>
				<% } %>
			</li>
		<% } %>
	</ul>
<% }Â %>

<% if (1 || (options.allowCancel && subscriptions.length && !user.stripe.canceled)) { %>

<p class="mt-3"><small><a class='text-danger' href='javascript:' data-toggle="modal" data-target="#cancelModal">Cancel your subscription</a></small></p>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-2" role="dialog" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				
				<h5 class="modal-title">Are you sure?</h5>
				
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>

			</div>

			<form action='/billing/cancelsubscription' method="post">
				<div class="modal-body">
					<div class="container-fluid">
						<textarea class='mb-4 form-control' name='feedback' placeholder="Mind letting us know how we can make the product better?"></textarea>
						<p>Your subscription will be canceled at the end of the current billing period at which point all privileged features will be disabled.</p>
					</div>
				</div>

				<div class="modal-footer">
					<a class='mr-3' href='javascript:' data-dismiss="modal" aria-label="Close">Go back</a>
					<button type="submit" class="btn btn-warning">Cancel my subscription</button>
				</div>
			</form>
		</div>
	</div>
</div>

<% } %>

<!-- Card Modal -->
<div class="modal fade" id="cardModal" tabindex="-2" role="dialog" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				
				<h5 class="modal-title">Add a new card</h5>
				
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>

			</div>
			<form id="cardForm">
				<div class="modal-body">
					<div class="container-fluid">

						<p><small>Credit and debit cards are supported.</small></p>

						<div class='row mb-2'>
							<div class='col-6'>
								<label>Card number</label>
								<div class='cardNumber form-control'></div>
							</div>
							<div class='col-3'>
								<label>Expiry</label>
								<div class='cardExpiry form-control'></div>
							</div>
							<div class='col-3'>
								<label>CVC</label>
								<div class='cardCvc form-control'></div>
							</div>
						</div>

						<div class='errors text-danger' role="alert"></div>
						
						<div class="mt-4 d-flex justify-content-between align-items-end">
							<small>Card stored securely with <a href='https://stripe.com'>Stripe</a></small>

							<button type="submit" class="btn btn-primary">
								<span style='display:none' class="spinner-border spinner-border-sm"></span>
								<span>Add â†’</span>
							</button>
						</div>
					</div>
				</div>
				
			</form>
		</div>
	</div>
</div>



<% if (options.upgradable) { %>
<!-- Upgrade Modal -->
<div class="modal fade" id="upgradeModal" tabindex="-1" role="dialog" aria-hidden="true">
	<div style="max-width: <%= upgradablePlans.length * 400 %>px;" class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">

			<div class="modal-body">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
					<%- include('upgradeForm.ejs') %>
			</div>
		</div>
	</div>
</div>
<% } %>

<script>

	function initStripe() {

		let stripe = Stripe("<%= options.publicKey %>")

		// Create an instance of the card Element.

		const elementsOptions = <%- JSON.stringify(stripeElementsOptions) %>;

		<% if (options.upgradable) { %> 
			
			<%- include('upgrade.js.ejs') %>

		<% } %>

		/*** Second element for the adding card flow **/
		
		let elements2 = stripe.elements()
		let cardNumber2 = elements2.create('cardNumber', elementsOptions)
		cardNumber2.mount('#cardForm .cardNumber')

		let cardExpiry2 = elements2.create('cardExpiry', elementsOptions)
		cardExpiry2.mount('#cardForm .cardExpiry')

		let cardCvc2 = elements2.create('cardCvc', elementsOptions)
		cardCvc2.mount('#cardForm .cardCvc')

		for (let el of [cardNumber2, cardCvc2, cardExpiry2]) {
			el.addEventListener('change', (event) => {
				$('#cardForm .error').text(event.error ? event.error.message : '')
			})
		}

		$('#cardForm').submit(function(event) {
			event.preventDefault()
			
			$('#cardForm button .spinner-border').show()

			$.get('/billing/setupintent', data => {

				stripe.handleCardSetup(data.clientSecret, cardNumber2).then((result) => {

					if (result.error) {
						$('#cardForm button .spinner-border').hide()
						$('#cardForm .error').text(result.error.message)
						return 
					}

					let paymentMethodId = result.setupIntent.payment_method
				
					$.post('/billing/card', {
						paymentMethodId: paymentMethodId
					}, (data) => {

						$( document ).trigger( "billing:cardadded" )

						// https://stackoverflow.com/questions/11519660/twitter-bootstrap-modal-backdrop-doesnt-disappear
						$('#cardModal').modal('hide').on('hidden.bs.modal', function()Â {
							billing.reload("#billingSection")
						})

					}).fail(e => {
						$('#cardForm button .spinner-border').hide()
						$('#cardForm .error').text("We couldn't add your card. Please try again or with another card.")
						console.error(e)
					})

				}).fail(e => {
					$('#cardForm button .spinner-border').hide()
					$('#cardForm .card-errors').text("We couldn't contact our servers. Please try again later.")
					console.error(e)
				})
			})
		})

	}

</script>